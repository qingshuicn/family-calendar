(function(){"use strict";var e={7725:function(e,t,n){var a=n(3751),o=n(4445),s=n(641);const l={id:"app"};function r(e,t,n,a,o,r){const i=(0,s.g2)("router-view");return(0,s.uX)(),(0,s.CE)("div",l,[(0,s.Lk)("main",null,[(0,s.bF)(i)])])}var i={name:"App"},c=n(6262);const u=(0,c.A)(i,[["render",r]]);var d=u,v=n(5220);const m=e=>((0,s.Qi)("data-v-d64e7b0c"),e=e(),(0,s.jt)(),e),p={class:"home-view"},h={class:"header"},g=m((()=>(0,s.Lk)("h1",null,"家庭日程",-1))),f={class:"layout"},b={class:"sidebar"},k={class:"main-content"},y={key:0,class:"modal"},w={class:"modal-content"};function C(e,t,n,a,o,l){const r=(0,s.g2)("CurrentDateTime"),i=(0,s.g2)("MonthlyCalendar"),c=(0,s.g2)("FamilyTabs"),u=(0,s.g2)("EventBlockView"),d=(0,s.g2)("RoleManagement");return(0,s.uX)(),(0,s.CE)("div",p,[(0,s.Lk)("header",h,[g,(0,s.bF)(r)]),(0,s.Lk)("div",f,[(0,s.Lk)("div",b,[(0,s.bF)(i,{events:a.eventStore.events,onDateSelected:a.handleDateSelected,onSearch:a.handleSearch},null,8,["events","onDateSelected","onSearch"]),(0,s.bF)(c,{onOpenRoleManagement:t[0]||(t[0]=e=>a.showRoleManagement=!0)})]),(0,s.Lk)("div",k,[(0,s.bF)(u)])]),a.showRoleManagement?((0,s.uX)(),(0,s.CE)("div",y,[(0,s.Lk)("div",w,[(0,s.Lk)("button",{onClick:t[1]||(t[1]=e=>a.showRoleManagement=!1),class:"close-btn"},"×"),(0,s.bF)(d)])])):(0,s.Q3)("",!0)])}var D=n(953),S=(n(4114),n(7642),n(8004),n(3853),n(5876),n(2475),n(5024),n(1698),n(4335));const L=(0,o.nY)("events",{state:()=>({familyMembers:[],events:[],selectedMember:null,selectedDate:new Date,searchQuery:"",pendingEvents:new Set}),getters:{filteredEvents:e=>e.events.filter((t=>{const n=new Date(t.startDate),a=n.getFullYear()===e.selectedDate.getFullYear()&&n.getMonth()===e.selectedDate.getMonth()&&n.getDate()===e.selectedDate.getDate(),o=!e.searchQuery||t.title.toLowerCase().includes(e.searchQuery.toLowerCase()),s=!e.selectedMember||"全家"===e.selectedMember||t.role===e.selectedMember;return a&&o&&s}))},actions:{async fetchEvents(){try{const e=await S.A.get("/api/events");this.events=e.data,console.log("Fetched events:",this.events)}catch(e){console.error("获取事件失败:",e)}},setSelectedMember(e){console.log("Setting selected member:",e),this.selectedMember=e},resetSelectedMember(){console.log("Resetting selected member"),this.selectedMember=null},async fetchFamilyMembers(){try{const e=await S.A.get("/api/roles");this.familyMembers=e.data.map((e=>({id:e._id,name:e.name,weeklyStars:0,isDefault:e.isDefault,color:e.color||this.getDefaultColor(e.name),borderColor:e.borderColor||this.getDefaultBorderColor(e.name)})))}catch(e){console.error("获取家庭成员失败:",e)}},getDefaultColor(e){const t={"全家":"#e0e0e0","爸爸":"#bbdefb","妈妈":"#f8bbd0","弟弟":"#c8e6c9","姐姐":"#ffecb3","阿姨":"#d7ccc8"};return t[e]||"#e0e0e0"},getDefaultBorderColor(e){const t={"全家":"#9e9e9e","爸爸":"#1976d2","妈妈":"#e91e63","弟弟":"#4caf50","姐姐":"#ffa000","阿姨":"#795548"};return t[e]||"#9e9e9e"},setEventsFromWebSocket(e){this.events=e},addEventFromWebSocket(e){const t=this.events.findIndex((t=>t._id===e._id||t.title===e.title&&t.startDate===e.startDate&&t.endDate===e.endDate&&t.role===e.role));-1===t?this.events.push(e):this.events[t]=e,this.events=[...this.events],console.log("从 WebSocket 添加或更新事件:",e)},async addEvent(e){const t=`${e.title}-${e.startDate}`;if(this.pendingEvents.has(t))console.log("事件正在添加中，忽略重复请求");else{this.pendingEvents.add(t);try{const t=await S.A.post("/api/events",e);return console.log("事件已添加到服务器:",t.data),t.data}catch(n){throw console.error("添加事件失败:",n),n}finally{this.pendingEvents.delete(t)}}},async updateEventCompletion(e,t){try{const n=await S.A.put(`/api/events/${e}/complete`,{completed:t}),a=n.data.event,o=this.events.findIndex((t=>t._id===e));return-1!==o&&(this.events[o]={...this.events[o],...a}),n.data.updatedStars}catch(n){console.error("更新事件完成状态失败:",n)}},async fetchWeeklyStars(){try{const e=await S.A.get("/api/weekly-stars"),t=e.data;this.familyMembers.forEach((e=>{e.weeklyStars=t[e.id]||0}))}catch(e){console.error("获取每周星星数据失败:",e)}},setSelectedDate(e){this.selectedDate=e},setSearchQuery(e){this.searchQuery=e},async addRole(e){try{const t=await S.A.post("/api/roles",{name:e}),n={id:t.data._id,name:t.data.name,weeklyStars:0,isDefault:!1,color:this.getDefaultColor(t.data.name),borderColor:this.getDefaultBorderColor(t.data.name)};this.familyMembers.push(n)}catch(t){console.error("添加角色失败:",t)}},async deleteRole(e){try{await S.A.delete(`/api/roles/${e}`),this.familyMembers=this.familyMembers.filter((t=>t.id!==e))}catch(t){console.error("删除角色失败:",t)}},async updateRole(e,t){try{await S.A.put(`/api/roles/${e}`,{name:t});const n=this.familyMembers.findIndex((t=>t.id===e));-1!==n&&(this.familyMembers[n].name=t,this.familyMembers[n].color=this.getDefaultColor(t),this.familyMembers[n].borderColor=this.getDefaultBorderColor(t))}catch(n){console.error("更新角色失败:",n)}}}});var E=n(33);const M=e=>((0,s.Qi)("data-v-3e301076"),e=e(),(0,s.jt)(),e),_=M((()=>(0,s.Lk)("h2",null,"添加新日程",-1))),T={class:"form-group"},I=M((()=>(0,s.Lk)("label",{for:"title"},"标题：",-1))),F={class:"form-group"},X=M((()=>(0,s.Lk)("label",{for:"description"},"描述：",-1))),R={class:"form-group"},W=M((()=>(0,s.Lk)("label",{for:"startTime"},"开始时间：",-1))),A=["value"],K={class:"form-group"},$=M((()=>(0,s.Lk)("label",{for:"endTime"},"结束时间：",-1))),O=["value"],x={class:"form-group"},j=M((()=>(0,s.Lk)("label",{for:"role"},"角色：",-1))),N=M((()=>(0,s.Lk)("option",{value:""},"请选择角色",-1))),Q=["value"],V=M((()=>(0,s.Lk)("button",{type:"submit"},"提交",-1)));var U={__name:"EventModal",props:{selectedMember:String},emits:["close","submit"],setup(e,{emit:t}){const n=L(),o=e,l=t,r=(0,D.KR)({title:"",description:"",startTime:"",endTime:"",role:""}),i=(0,D.KR)([]),c=(0,s.EW)((()=>{const e=i.value.indexOf(r.value.startTime);return i.value.slice(e+1)})),u=(0,s.EW)((()=>{const e=[...n.familyMembers],t=e.find((e=>"all"===e.id));return t&&(e.splice(e.indexOf(t),1),e.unshift(t)),e.sort(((e,t)=>"all"===e.id?-1:"all"===t.id?1:e.name.localeCompare(t.name)))}));function d(){const e=[],t=new Date,n=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0);for(let a=0;a<96;a++){const t=new Date(n.getTime()+15*a*6e4);e.push(t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}))}i.value=e}function v(){const e=new Date,t=e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),n=i.value.reduce(((e,n)=>Math.abs(new Date("1970/01/01 "+n)-new Date("1970/01/01 "+t))<Math.abs(new Date("1970/01/01 "+e)-new Date("1970/01/01 "+t))?n:e));r.value.startTime=n;const a=i.value.indexOf(n),o=Math.min(a+4,i.value.length-1);r.value.endTime=i.value[o]}function m(){l("close")}function p(){const e=new Date,[t,n]=r.value.startTime.split(":"),[a,o]=r.value.endTime.split(":"),s=new Date(e.getFullYear(),e.getMonth(),e.getDate(),parseInt(t),parseInt(n)),i=new Date(e.getFullYear(),e.getMonth(),e.getDate(),parseInt(a),parseInt(o));i<s&&i.setDate(i.getDate()+1);const c={title:r.value.title,description:r.value.description,startDate:s.toISOString().slice(0,19),endDate:i.toISOString().slice(0,19),role:r.value.role||null};console.log("Submitting event:",c),l("submit",c)}return(0,s.sV)((()=>{d(),v(),r.value.role=o.selectedMember||""})),(0,s.wB)((()=>o.selectedMember),(e=>{r.value.role=e||""})),(e,t)=>((0,s.uX)(),(0,s.CE)("div",{class:"modal-overlay",onClick:m},[(0,s.Lk)("div",{class:"modal-content",onClick:t[5]||(t[5]=(0,a.D$)((()=>{}),["stop"]))},[_,(0,s.Lk)("form",{onSubmit:(0,a.D$)(p,["prevent"])},[(0,s.Lk)("div",T,[I,(0,s.bo)((0,s.Lk)("input",{id:"title","onUpdate:modelValue":t[0]||(t[0]=e=>r.value.title=e),required:""},null,512),[[a.Jo,r.value.title]])]),(0,s.Lk)("div",F,[X,(0,s.bo)((0,s.Lk)("textarea",{id:"description","onUpdate:modelValue":t[1]||(t[1]=e=>r.value.description=e),required:""},null,512),[[a.Jo,r.value.description]])]),(0,s.Lk)("div",R,[W,(0,s.bo)((0,s.Lk)("select",{id:"startTime","onUpdate:modelValue":t[2]||(t[2]=e=>r.value.startTime=e),required:""},[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(i.value,(e=>((0,s.uX)(),(0,s.CE)("option",{key:e,value:e},(0,E.v_)(e),9,A)))),128))],512),[[a.u1,r.value.startTime]])]),(0,s.Lk)("div",K,[$,(0,s.bo)((0,s.Lk)("select",{id:"endTime","onUpdate:modelValue":t[3]||(t[3]=e=>r.value.endTime=e),required:""},[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(c.value,(e=>((0,s.uX)(),(0,s.CE)("option",{key:e,value:e},(0,E.v_)(e),9,O)))),128))],512),[[a.u1,r.value.endTime]])]),(0,s.Lk)("div",x,[j,(0,s.bo)((0,s.Lk)("select",{id:"role","onUpdate:modelValue":t[4]||(t[4]=e=>r.value.role=e),required:""},[N,((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(u.value,(e=>((0,s.uX)(),(0,s.CE)("option",{key:e.id,value:e.id},(0,E.v_)(e.name),9,Q)))),128))],512),[[a.u1,r.value.role]])]),(0,s.Lk)("div",{class:"form-actions"},[(0,s.Lk)("button",{type:"button",onClick:m},"取消"),V])],32)])]))}};const Y=(0,c.A)(U,[["__scopeId","data-v-3e301076"]]);var B=Y;const P={class:"family-tabs"},z={class:"member-list"},q=["onClick"],J={class:"avatar-container"},G=["src","alt"],H={key:1,class:"avatar-placeholder"},Z={class:"member-info"},ee={class:"member-name"},te={class:"star"},ne={class:"action-buttons"};var ae={__name:"FamilyTabs",setup(e){const t=L(),n=(0,D.KR)(!1);let a=null;const o=(0,s.EW)((()=>[...t.familyMembers].sort(((e,t)=>"全家"===e.name?-1:"全家"===t.name?1:e.name.localeCompare(t.name)))));function l(e){t.selectedMember===e?(t.resetSelectedMember(),clearTimeout(a),a=null):(t.setSelectedMember(e),r())}function r(){a&&clearTimeout(a),a=setTimeout((()=>{t.resetSelectedMember(),a=null}),3e4)}function i(){n.value=!0}function c(){n.value=!1}async function u(e){try{await t.addEvent(e),c()}catch(n){console.error("创建新事件失败:",n)}}return(0,s.hi)((()=>{a&&clearTimeout(a)})),(e,a)=>((0,s.uX)(),(0,s.CE)("div",P,[(0,s.Lk)("div",z,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(o.value,(e=>((0,s.uX)(),(0,s.CE)("div",{key:e.id,class:(0,E.C4)(["member-tab",{active:e.name===(0,D.R1)(t).selectedMember}]),onClick:t=>l(e.name),style:(0,E.Tr)({backgroundColor:e.color,borderColor:e.borderColor})},[(0,s.Lk)("div",J,[e.avatar?((0,s.uX)(),(0,s.CE)("img",{key:0,src:e.avatar,alt:e.name,class:"member-avatar"},null,8,G)):((0,s.uX)(),(0,s.CE)("div",H))]),(0,s.Lk)("div",Z,[(0,s.Lk)("span",ee,(0,E.v_)(e.name),1),(0,s.Lk)("span",te,"⭐ "+(0,E.v_)(e.weeklyStars),1)])],14,q)))),128))]),(0,s.Lk)("div",ne,[(0,s.Lk)("button",{onClick:i,class:"add-event-btn"},"添加日程"),(0,s.Lk)("button",{onClick:a[0]||(a[0]=t=>e.$emit("open-role-management")),class:"manage-roles-btn"},"管理角色")]),n.value?((0,s.uX)(),(0,s.Wv)(B,{key:0,selectedMember:(0,D.R1)(t).selectedMember,onClose:c,onSubmit:u},null,8,["selectedMember"])):(0,s.Q3)("",!0)]))}};const oe=(0,c.A)(ae,[["__scopeId","data-v-e0f1d60c"]]);var se=oe;const le={class:"event-block-view"},re={class:"event-time"},ie={class:"event-content"},ce={class:"event-description"},ue={class:"event-role"},de={class:"event-actions"},ve=["onClick"];var me={__name:"EventBlockView",setup(e){const t=L(),n=(0,s.EW)((()=>[...t.filteredEvents].sort(((e,t)=>{const n=new Date(e.startDate)-new Date(t.startDate);return 0!==n?n:e.role.localeCompare(t.role)}))));function a(e){return`${e._id}-${e.startDate}-${e.endDate}-${e.role}-${e.title}`}function o(e){const t=new Date(e.startDate),n=new Date(e.endDate);return`${t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})} - ${n.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}`}function l(e){const n=t.familyMembers.find((t=>t.name===e.role));return{backgroundColor:n?`${n.color}33`:"#e1f5fe33",borderLeft:`4px solid ${n?n.borderColor:"#03a9f4"}`}}async function r(e){try{const n=await t.updateEventCompletion(e._id,!e.completed);console.log("Updated stars:",n)}catch(n){console.error("更新事件完成状态失败:",n)}}return(e,t)=>((0,s.uX)(),(0,s.CE)("div",le,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(n.value,(e=>((0,s.uX)(),(0,s.CE)("div",{key:a(e),class:"event-block",style:(0,E.Tr)(l(e))},[(0,s.Lk)("div",re,(0,E.v_)(o(e)),1),(0,s.Lk)("div",ie,[(0,s.Lk)("h3",null,(0,E.v_)(e.title),1),(0,s.Lk)("p",ce,(0,E.v_)(e.description),1),(0,s.Lk)("p",ue,(0,E.v_)(e.role),1)]),(0,s.Lk)("div",de,[(0,s.Lk)("button",{onClick:t=>r(e),class:(0,E.C4)({completed:e.completed})},(0,E.v_)(e.completed?"已完成":"完成"),11,ve)])],4)))),128))]))}};const pe=(0,c.A)(me,[["__scopeId","data-v-2e65249a"]]);var he=pe;const ge={class:"current-date-time"};var fe={__name:"CurrentDateTime",setup(e){const t=(0,D.KR)("");function n(){const e=new Date,n=e.toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric"}),a=e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});t.value=`${n} ${a}`}let a;return(0,s.sV)((()=>{n(),a=setInterval(n,6e4)})),(0,s.hi)((()=>{clearInterval(a)})),(e,n)=>((0,s.uX)(),(0,s.CE)("div",ge,(0,E.v_)(t.value),1))}};const be=(0,c.A)(fe,[["__scopeId","data-v-80a1425c"]]);var ke=be;const ye={class:"monthly-calendar"},we={class:"calendar-header"},Ce={class:"calendar-grid"},De=["onClick"],Se={key:0,class:"event-indicator"};function Le(e,t,n,a,o,l){return(0,s.uX)(),(0,s.CE)("div",ye,[(0,s.Lk)("div",we,[(0,s.Lk)("button",{onClick:t[0]||(t[0]=(...e)=>a.previousMonth&&a.previousMonth(...e))},"<"),(0,s.Lk)("span",null,(0,E.v_)(a.currentMonthYear),1),(0,s.Lk)("button",{onClick:t[1]||(t[1]=(...e)=>a.nextMonth&&a.nextMonth(...e))},">")]),(0,s.Lk)("div",Ce,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(a.weekdays,(e=>((0,s.uX)(),(0,s.CE)("div",{key:e,class:"weekday"},(0,E.v_)(e),1)))),128)),((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(a.calendarDays,(e=>((0,s.uX)(),(0,s.CE)("div",{key:`${a.currentMonthYear}-${e.date}`,class:(0,E.C4)(["calendar-day",{"current-month":e.isCurrentMonth,today:e.isToday,"has-events":e.hasEvents}]),onClick:t=>a.selectDate(e)},[(0,s.eW)((0,E.v_)(e.date)+" ",1),e.hasEvents?((0,s.uX)(),(0,s.CE)("div",Se)):(0,s.Q3)("",!0)],10,De)))),128))])])}var Ee={name:"MonthlyCalendar",props:{events:{type:Array,default:()=>[]}},setup(e,{emit:t}){const n=L(),a=(0,D.KR)(new Date),o=["日","一","二","三","四","五","六"],l=(0,s.EW)((()=>a.value.toLocaleString("zh-CN",{year:"numeric",month:"long"}))),r=(0,s.EW)((()=>{const t=a.value.getFullYear(),n=a.value.getMonth(),o=new Date(t,n,1),s=new Date(t,n+1,0),l=s.getDate(),r=o.getDay(),i=[],c=new Date;for(let e=r-1;e>=0;e--){const a=new Date(t,n,-e);i.push({date:a.getDate(),isCurrentMonth:!1,isToday:!1,hasEvents:!1})}for(let e=1;e<=l;e++){const a=new Date(t,n,e);i.push({date:e,isCurrentMonth:!0,isToday:a.toDateString()===c.toDateString(),hasEvents:!1})}const u=42-i.length;for(let e=1;e<=u;e++)i.push({date:e,isCurrentMonth:!1,isToday:!1,hasEvents:!1});return i.forEach((a=>{a.hasEvents=e.events.some((e=>{const o=new Date(e.date);return o.getDate()===a.date&&o.getMonth()===n&&o.getFullYear()===t}))})),i}));function i(){a.value=new Date(a.value.getFullYear(),a.value.getMonth()-1,1)}function c(){a.value=new Date(a.value.getFullYear(),a.value.getMonth()+1,1)}function u(e){if(e.isCurrentMonth){const o=new Date(a.value.getFullYear(),a.value.getMonth(),e.date);n.setSelectedDate(o),t("date-selected",o)}}return(0,s.nT)((()=>{console.log("Month changed:",a.value.toISOString())})),{currentMonthYear:l,weekdays:o,calendarDays:r,previousMonth:i,nextMonth:c,selectDate:u}}};const Me=(0,c.A)(Ee,[["render",Le],["__scopeId","data-v-239ece5b"]]);var _e=Me;const Te=e=>((0,s.Qi)("data-v-0678cc2a"),e=e(),(0,s.jt)(),e),Ie={class:"role-management"},Fe=Te((()=>(0,s.Lk)("h2",null,"角色管理",-1))),Xe={class:"add-role"},Re={class:"role-list"},We=["onKeyup"],Ae=["onClick"],Ke=["onClick"],$e=["onClick"];var Oe={__name:"RoleManagement",setup(e){const t=L(),n=(0,D.KR)(""),o=(0,D.KR)(null),l=(0,D.KR)(""),r=()=>{n.value.trim()&&(t.addRole(n.value.trim()),n.value="")},i=e=>{o.value=e.id,l.value=e.name},c=e=>{l.value.trim()&&(t.updateRole(e,l.value.trim()),u())},u=()=>{o.value=null,l.value=""},d=e=>{confirm("确定要删除这个角色吗？")&&t.deleteRole(e)};return(e,v)=>((0,s.uX)(),(0,s.CE)("div",Ie,[Fe,(0,s.Lk)("div",Xe,[(0,s.bo)((0,s.Lk)("input",{"onUpdate:modelValue":v[0]||(v[0]=e=>n.value=e),placeholder:"输入新角色名称"},null,512),[[a.Jo,n.value]]),(0,s.Lk)("button",{onClick:r},"添加角色")]),(0,s.Lk)("ul",Re,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)((0,D.R1)(t).familyMembers,(e=>((0,s.uX)(),(0,s.CE)("li",{key:e.id,class:"role-item"},[o.value===e.id?((0,s.uX)(),(0,s.CE)(s.FK,{key:0},[(0,s.bo)((0,s.Lk)("input",{"onUpdate:modelValue":v[1]||(v[1]=e=>l.value=e),onKeyup:(0,a.jR)((t=>c(e.id)),["enter"])},null,40,We),[[a.Jo,l.value]]),(0,s.Lk)("button",{onClick:t=>c(e.id)},"保存",8,Ae),(0,s.Lk)("button",{onClick:u},"取消")],64)):((0,s.uX)(),(0,s.CE)(s.FK,{key:1},[(0,s.Lk)("span",null,(0,E.v_)(e.name),1),e.isDefault?(0,s.Q3)("",!0):((0,s.uX)(),(0,s.CE)("button",{key:0,onClick:t=>i(e)},"编辑",8,Ke)),e.isDefault?(0,s.Q3)("",!0):((0,s.uX)(),(0,s.CE)("button",{key:1,onClick:t=>d(e.id)},"删除",8,$e))],64))])))),128))])]))}};const xe=(0,c.A)(Oe,[["__scopeId","data-v-0678cc2a"]]);var je=xe;function Ne(e){const t=(0,D.KR)(null),n=(0,D.KR)(!1),a=()=>{const s="wss://family.aibigboom.com/ws";console.log("尝试连接到 WebSocket:",s),t.value=new WebSocket(s),t.value.onopen=()=>{console.log("WebSocket 连接已建立"),n.value=!1},t.value.onmessage=t=>{console.log("收到 WebSocket 消息:",t.data);try{const n=JSON.parse(t.data);"initial"===n.type?e.setEventsFromWebSocket(n.events):"newEvent"===n.type&&(console.log("收到新事件:",n.event),e.addEventFromWebSocket(n.event))}catch(n){console.error("处理 WebSocket 消息时出错:",n)}},t.value.onerror=e=>{console.error("WebSocket 错误:",e),n.value||(console.log("切换到轮询模式"),o())},t.value.onclose=e=>{console.log(`WebSocket 连接关闭。代码: ${e.code}, 原因: ${e.reason}`),n.value||(console.log("5秒后尝试重新连接..."),setTimeout(a,5e3))}},o=async()=>{if(n.value)return;n.value=!0;const t=async()=>{try{await e.fetchEvents(),e.$patch({events:[...e.events]})}catch(a){console.error("轮询错误:",a)}n.value&&setTimeout(t,5e3)};t()},s=()=>{t.value&&t.value.close(),n.value=!1};return{connectWebSocket:a,disconnectWebSocket:s}}var Qe={name:"HomeView",components:{FamilyTabs:se,EventBlockView:he,CurrentDateTime:ke,MonthlyCalendar:_e,RoleManagement:je},setup(){const e=L(),{connectWebSocket:t,disconnectWebSocket:n}=Ne(e),a=(0,D.KR)(!1);function o(t){e.setSelectedDate(t)}function l(t){e.setSearchQuery(t)}return(0,s.sV)((async()=>{await e.fetchFamilyMembers(),await e.fetchEvents(),await e.fetchWeeklyStars(),e.setSelectedDate(new Date),t()})),(0,s.hi)((()=>{n()})),(0,s.wB)((()=>e.events),(()=>{console.log("Events updated:",e.events.length)}),{deep:!0}),(0,s.wB)((()=>e.filteredEvents),(()=>{console.log("Filtered events updated:",e.filteredEvents.length)}),{deep:!0}),{eventStore:e,handleDateSelected:o,handleSearch:l,showRoleManagement:a}}};const Ve=(0,c.A)(Qe,[["render",C],["__scopeId","data-v-d64e7b0c"]]);var Ue=Ve;const Ye=e=>((0,s.Qi)("data-v-2789af02"),e=e(),(0,s.jt)(),e),Be={class:"schedule-input-view"},Pe=Ye((()=>(0,s.Lk)("h2",null,"日程安排输入",-1))),ze=["disabled"],qe={key:0,class:"response-area"},Je=Ye((()=>(0,s.Lk)("h3",null,"响应：",-1)));function Ge(e,t,n,o,l,r){return(0,s.uX)(),(0,s.CE)("div",Be,[Pe,(0,s.bo)((0,s.Lk)("textarea",{"onUpdate:modelValue":t[0]||(t[0]=e=>l.scheduleInput=e),placeholder:"输入您的日程安排...",rows:"4"},null,512),[[a.Jo,l.scheduleInput]]),(0,s.Lk)("button",{onClick:t[1]||(t[1]=(...e)=>r.submitSchedule&&r.submitSchedule(...e)),disabled:l.isSubmitting},(0,E.v_)(l.isSubmitting?"提交中...":"提交日程"),9,ze),l.response?((0,s.uX)(),(0,s.CE)("div",qe,[Je,(0,s.Lk)("pre",null,(0,E.v_)(l.response),1)])):(0,s.Q3)("",!0)])}var He={name:"ScheduleInputView",data(){return{scheduleInput:"",apiKey:"app-zyuogN6iPjys8j4R7fTj8M2z",apiUrl:"https://api.dify.ai/v1/workflows/run",userId:"your-user-id",response:null,isSubmitting:!1}},methods:{async submitSchedule(){if(!this.isSubmitting){this.isSubmitting=!0;try{console.log("正在发送请求..."),console.log("API URL:",this.apiUrl),console.log("API Key (前5个字符):",this.apiKey.substring(0,5));const e={inputs:{input:this.scheduleInput},response_mode:"blocking",user:this.userId};console.log("请求体:",JSON.stringify(e));const t=await(0,S.A)({method:"post",url:this.apiUrl,data:e,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey.trim()}`}});console.log("响应:",t.data),t.data&&t.data.data&&t.data.data.outputs&&t.data.data.outputs.text?this.response=t.data.data.outputs.text:(this.response="未找到有效的输出",console.log("API 响应中没有找到预期的输出结构"))}catch(e){console.error("提交日程时出错:",e.message),e.response?(console.error("错误数据:",e.response.data),console.error("错误状态:",e.response.status),console.error("错误头部:",e.response.headers),this.response="错误: "+JSON.stringify(e.response.data,null,2)):e.request?(console.error("未收到响应:",e.request),this.response="错误: 未收到服务器响应"):this.response="错误: "+e.message}finally{this.isSubmitting=!1}}}}};const Ze=(0,c.A)(He,[["render",Ge],["__scopeId","data-v-2789af02"]]);var et=Ze;const tt=[{path:"/",name:"home",component:Ue},{path:"/schedule-input",name:"scheduleInput",component:et}],nt=(0,v.aE)({history:(0,v.LA)("/"),routes:tt});var at=nt,ot=n(3723);(0,ot.k)("/service-worker.js",{ready(){console.log("App is being served from cache by a service worker.\nFor more details, visit https://goo.gl/AFskqB")},registered(e){console.log("Service worker has been registered."),setInterval((()=>{e.update()}),36e5)},cached(){console.log("Content has been cached for offline use.")},updatefound(){console.log("New content is downloading.")},updated(e){console.log("New content is available; please refresh.");const t=e.waiting;window.confirm("新版本可用。是否刷新页面？")&&(t.postMessage({type:"SKIP_WAITING"}),window.location.reload())},offline(){console.log("No internet connection found. App is running in offline mode.")},error(e){console.error("Error during service worker registration:",e)}}),S.A.defaults.baseURL="https://family.aibigboom.com";const st=(0,a.Ef)(d),lt=(0,o.Ey)();st.use(at),st.use(lt);const rt=()=>{"wakeLock"in navigator?navigator.wakeLock.request("screen").then((()=>{console.log("Screen will stay awake")})).catch((e=>{console.error(`${e.name}, ${e.message}`)})):console.warn("Wake Lock API not supported")};if("serviceWorker"in navigator){navigator.serviceWorker.ready.then((e=>{e.addEventListener("updatefound",(()=>{const t=e.installing;t.addEventListener("statechange",(()=>{if("installed"===t.state&&navigator.serviceWorker.controller){const e=window.confirm("新版本可用。是否立即更新？");e&&(t.postMessage({type:"SKIP_WAITING"}),window.location.reload())}}))}))}));let e=!1;navigator.serviceWorker.addEventListener("controllerchange",(()=>{e||(window.location.reload(),e=!0)}))}st.mount("#app"),rt()}},t={};function n(a){var o=t[a];if(void 0!==o)return o.exports;var s=t[a]={exports:{}};return e[a].call(s.exports,s,s.exports,n),s.exports}n.m=e,function(){var e=[];n.O=function(t,a,o,s){if(!a){var l=1/0;for(u=0;u<e.length;u++){a=e[u][0],o=e[u][1],s=e[u][2];for(var r=!0,i=0;i<a.length;i++)(!1&s||l>=s)&&Object.keys(n.O).every((function(e){return n.O[e](a[i])}))?a.splice(i--,1):(r=!1,s<l&&(l=s));if(r){e.splice(u--,1);var c=o();void 0!==c&&(t=c)}}return t}s=s||0;for(var u=e.length;u>0&&e[u-1][2]>s;u--)e[u]=e[u-1];e[u]=[a,o,s]}}(),function(){n.d=function(e,t){for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})}}(),function(){n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){n.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){var e={524:0};n.O.j=function(t){return 0===e[t]};var t=function(t,a){var o,s,l=a[0],r=a[1],i=a[2],c=0;if(l.some((function(t){return 0!==e[t]}))){for(o in r)n.o(r,o)&&(n.m[o]=r[o]);if(i)var u=i(n)}for(t&&t(a);c<l.length;c++)s=l[c],n.o(e,s)&&e[s]&&e[s][0](),e[s]=0;return n.O(u)},a=self["webpackChunkfrontend"]=self["webpackChunkfrontend"]||[];a.forEach(t.bind(null,0)),a.push=t.bind(null,a.push.bind(a))}();var a=n.O(void 0,[504],(function(){return n(7725)}));a=n.O(a)})();
//# sourceMappingURL=app.c9f7d357.js.map